<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>简单的分库分表实践案例 | 贺墨于的博客</title><meta name="keywords" content="分库分表,Java,后台"><meta name="author" content="贺墨于"><meta name="copyright" content="贺墨于"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="由于业务庞大，数据增长快，为了缓解数据库压力需要进行分库分表。本文的目标是展示一个具体的数据库路由组件的实践案例。这个案例通过自定义一个 springboot 的 starter 来实现。   什么是分库分表？ 分库分表其实很好理解，「顾名思义，即把存于一个库的数据分散到多个库中，把存于一个表的数据分散到多个表中」。分库分表有三种方案：  「只分库不分表」 「只分表不分库」 「既分库又分表」"><meta property="og:type" content="article"><meta property="og:title" content="简单的分库分表实践案例"><meta property="og:url" content="https://motang.top/2023/10/24/%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B/index.html"><meta property="og:site_name" content="贺墨于的博客"><meta property="og:description" content="由于业务庞大，数据增长快，为了缓解数据库压力需要进行分库分表。本文的目标是展示一个具体的数据库路由组件的实践案例。这个案例通过自定义一个 springboot 的 starter 来实现。   什么是分库分表？ 分库分表其实很好理解，「顾名思义，即把存于一个库的数据分散到多个库中，把存于一个表的数据分散到多个表中」。分库分表有三种方案：  「只分库不分表」 「只分表不分库」 「既分库又分表」"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><meta property="article:published_time" content="2023-10-24T11:48:32.735Z"><meta property="article:modified_time" content="2023-10-24T11:58:06.574Z"><meta property="article:author" content="贺墨于"><meta property="article:tag" content="分库分表"><meta property="article:tag" content="Java"><meta property="article:tag" content="后台"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/images/hemou-icon.png"><link rel="canonical" href="https://motang.top/2023/10/24/%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#1f1f1f",position:"bottom-left"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"简单的分库分表实践案例",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-10-24 19:58:06"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0!==o){const a=new Date;o=864e5*o,t={value:t,expiry:a.getTime()+o};localStorage.setItem(e,JSON.stringify(t))}},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);const o=new Date;if(!(o.getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=a=>new Promise((t,e)=>{const o=document.createElement("script");o.src=a,o.async=!0,o.onerror=e,o.onload=o.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(o.onload=o.onreadystatechange=null,t())},document.head.appendChild(o)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="贺墨于的博客" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/avatar.webp" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">贺墨于的博客</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">简单的分库分表实践案例</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-10-24T11:48:32.735Z" title="发表于 2023-10-24 19:48:32">2023-10-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-10-24T11:58:06.574Z" title="更新于 2023-10-24 19:58:06">2023-10-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>8分钟</span></span></div></div></div><article class="post-content" id="article-container"><blockquote><p>由于业务庞大，数据增长快，为了缓解数据库压力需要进行分库分表。本文的目标是展示一个具体的数据库路由组件的实践案例。这个案例通过自定义一个 springboot 的 starter 来实现。</p></blockquote><h2 id="什么是分库分表"><a class="markdownIt-Anchor" href="#什么是分库分表"></a> 什么是分库分表？</h2><p>分库分表其实很好理解，<strong>「顾名思义，即把存于一个库的数据分散到多个库中，把存于一个表的数据分散到多个表中」</strong>。分库分表有三种方案：</p><ul><li><strong>「只分库不分表」</strong></li><li><strong>「只分表不分库」</strong></li><li><strong>「既分库又分表」</strong></li></ul><h3 id="只分库不分表"><a class="markdownIt-Anchor" href="#只分库不分表"></a> 只分库不分表</h3><p><strong>「从单个数据库拆分成多个数据库的过程，将数据散落在多个数据库中，多个数据库同时提供服务」</strong></p><p><img src="modb_20220718_bf402a9c-0658-11ed-a8c9-38f9d3cd240d.png" alt="只分库不分表"></p><h3 id="只分表不分库"><a class="markdownIt-Anchor" href="#只分表不分库"></a> 只分表不分库</h3><p><strong>「从单张表拆分成多张表的过程，将数据散落在多张表内」</strong></p><p><img src="modb_20220718_bf66ab04-0658-11ed-a8c9-38f9d3cd240d.png" alt="只分表不分库"></p><h3 id="既分库又分表"><a class="markdownIt-Anchor" href="#既分库又分表"></a> 既分库又分表</h3><p><strong>「把存于一个数据库的单表数据分散到不同库的多个表中」</strong></p><p><img src="modb_20220718_c04e2d8a-0658-11ed-a8c9-38f9d3cd240d.png" alt="既分库又分表"></p><h2 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h2><h3 id="确定需要数据"><a class="markdownIt-Anchor" href="#确定需要数据"></a> 确定需要数据</h3><p>知道了分库分表的概念，我们就可以确定 starter 所需要的数据了</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mini-db-router:</span></span><br><span class="line">  <span class="attr">jdbc:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">db-count:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">tb-count:</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">router-key:</span> <span class="string">uId</span></span><br><span class="line">      <span class="attr">default-db:</span> <span class="string">db00</span></span><br><span class="line">      <span class="attr">list:</span> <span class="string">db01,db02</span></span><br><span class="line">      <span class="attr">db-config-map:</span></span><br><span class="line">        <span class="attr">db00:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.101:3306/lottery?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">db01:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.101:3306/lottery_01?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">db02:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.56.101:3306/lottery_02?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></table></figure><ul><li>dbCount：分库数</li><li>tbCount：分表数</li><li>routerKey：路由键，用来确定哪一个库，哪一个表</li><li>defaultDb：默认数据库</li><li>list：分库数据库列表</li><li>dbConfigMap：数据库配置</li></ul><h3 id="创建-properties"><a class="markdownIt-Anchor" href="#创建-properties"></a> 创建 Properties</h3><p>为了读取在 yaml 文件中的配置，我们创建 <code>Properties</code> 来帮助我们便捷的读取 yaml 数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mini-db-router.jdbc.datasource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBRouterProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer dbCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer tbCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String list;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String defaultDb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String routerKey;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DbConfig&gt; dbConfigMap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DbConfig <span class="title function_">getDefaultDbConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dbConfigMap.get(defaultDb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DbConfig <span class="title function_">getDbConfig</span><span class="params">(String dbKey)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dbConfigMap.get(dbKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DbConfig</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String driverClassName;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line">        <span class="keyword">private</span> String username;</span><br><span class="line">        <span class="keyword">private</span> String password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="运行时如何决定库表"><a class="markdownIt-Anchor" href="#运行时如何决定库表"></a> 运行时如何决定库表？</h2><p>程序运行时我们需要判断具体要选择哪一个库，以及哪一个表，在这里就需要用到 <code>ThreadLocal</code>，它在线程中维护一个变量，并且能在同一线程中的任意上下文获取到这个变量，还起到线程间数据隔离的作用。</p><p>我们将 <code>dbKey</code> 以及 <code>tbKey</code> 用 <code>TreadLocal</code> 维护起来，它们两分别决定了该使用哪个库哪个表，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBContextHolder</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; dbKey = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;String&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; tbKey = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDbKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        dbKey.set(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDbKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dbKey.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTbKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        tbKey.set(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTbKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tbKey.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearDbKey</span><span class="params">()</span> &#123;</span><br><span class="line">        dbKey.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearTbKey</span><span class="params">()</span> &#123;</span><br><span class="line">        tbKey.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们只提到了如何维护 <code>dbKey</code> 和 <code>tbKey</code>，后面会再次说明如何设置以及使用这两个值</p><h2 id="设置-dbkey-以及-tbkey"><a class="markdownIt-Anchor" href="#设置-dbkey-以及-tbkey"></a> 设置 <code>dbKey</code> 以及 <code>tbKey</code></h2><p>前面提到可以说用 <code>DBContextHolder</code> 来维护 <code>dbKey</code> 以及 <code>tbKey</code> 这两个值，那何时去设置它们呢，这就要用到注解以及 aop 了。</p><p>只要在方法上标注了注解就说明我们想要分库分表了，然后借助 aop 就可以在执行数据库操作之前设置好 <code>dbKey</code> 以及 <code>tbKey</code> 这两个值。</p><h3 id="注解"><a class="markdownIt-Anchor" href="#注解"></a> 注解</h3><p><code>@DBRouter</code> 表明我们想要分库，同时可以用 key 来指定路由键</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DBRouter &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@DBRouterStrategy</code> 表明我们想要分表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DBRouterStrategy &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">splitTable</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建切面"><a class="markdownIt-Anchor" href="#创建切面"></a> 创建切面</h3><p>1、切点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut(&quot;@annotation(com.hemou.middleware.db.router.annotation.DBRouter)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aopPoint</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们对标注了 <code>@DBRouter</code> 的地方进行增强</p><p>2、通知</p><p>我们使用环绕通知</p><p>1）我们获取 <code>@DBRouter</code> 上表明的路由键，若为空，则使用 yaml 中配置的默认路由键</p><p>2）通过路由键我们获取对应的路由值，大多数是全局唯一ID</p><p>3）根据路由值计算该路由到哪个库哪个表，（也就是设置 <code>dbKey</code> 以及 <code>tbKey</code>）</p><p>4）执行原本方法</p><p>5）原方法执行完毕后，清除 <code>dbKey</code> 以及 <code>tbKey</code>，避免内存泄露</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint jp, DBRouter dbRouter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKey</span> <span class="operator">=</span> dbRouter.key();</span><br><span class="line">    dbKey = StringUtils.isNotBlank(dbKey) ? dbKey : dbRouterProperties.getRouterKey();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dbKey)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;annotation DBRouter key is null!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算路由</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKeyValue</span> <span class="operator">=</span> <span class="built_in">this</span>.getAttrValue(dbKey, jp.getArgs());</span><br><span class="line">    dbRouterStrategy.doRouter(dbKeyValue);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行方法</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jp.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 清除路由</span></span><br><span class="line">        dbRouterStrategy.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、具体路由值计算该路由到哪个库哪个表的方法</p><p>先通过 <code>dbCount</code> 以及 <code>tbCount</code> size，这个size必须是 2 的 n 次幂</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRouter</span><span class="params">(String dbKeyAttr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> dbRouterProperties.getDbCount() * dbRouterProperties.getTbCount();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (size - <span class="number">1</span>) &amp; (dbKeyAttr.hashCode() ^ (dbKeyAttr.hashCode() &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">dbIdx</span> <span class="operator">=</span> idx / dbRouterProperties.getTbCount() + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">tbIdx</span> <span class="operator">=</span> idx - dbRouterProperties.getTbCount() * (dbIdx - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    DBContextHolder.setDbKey(String.format(<span class="string">&quot;%02d&quot;</span>, dbIdx));</span><br><span class="line">    DBContextHolder.setTbKey(String.format(<span class="string">&quot;%03d&quot;</span>, tbIdx));</span><br><span class="line">    log.debug(<span class="string">&quot;数据库路由 dbIdx：&#123;&#125; tbIdx：&#123;&#125;&quot;</span>,  dbIdx, tbIdx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分库-数据库动态切换"><a class="markdownIt-Anchor" href="#分库-数据库动态切换"></a> 分库 - 数据库动态切换</h2><p>因为进行了分库，所以数据库不止一个，这里我们就可以根据 <code>dbKey</code> 来决定到底使用哪一个库了。我们将继承一个 <code>AbstractRoutingDataSource</code> 类，它的 <code>determineCurrentLookupKey()</code> 方法能帮我们动态的切换数据库，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DBRouterProperties dbRouterProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicDataSource</span><span class="params">(DBRouterProperties dbRouterProperties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dbRouterProperties = dbRouterProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == DBContextHolder.getDbKey()) &#123;</span><br><span class="line">            <span class="keyword">return</span> dbRouterProperties.getDefaultDb();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;db&quot;</span> + DBContextHolder.getDbKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里我们判断 DBContextHolder 维护的 <code>dbKey</code> 是否为空，如果为空则使用默认数据库，否则使用指定数据库。</p><p>我们所继承的这个 <code>AbstractRoutingDataSource</code> 构建时要求我们输入一个 Map 集合，它键对应的值就是数据源对象，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(DBRouterProperties dbRouterProperties)</span> &#123;</span><br><span class="line">    <span class="comment">// 创建数据源</span></span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, DbConfig&gt; entry : dbRouterProperties.getDbConfigMap().entrySet()) &#123;</span><br><span class="line">        <span class="type">DbConfig</span> <span class="variable">dbConfig</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        targetDataSources.put(entry.getKey(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>(dbConfig.getUrl(), dbConfig.getUsername(), dbConfig.getPassword()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置数据源</span></span><br><span class="line">    <span class="type">DynamicDataSource</span> <span class="variable">dynamicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>(dbRouterProperties);</span><br><span class="line">    dynamicDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">    dynamicDataSource.setDefaultTargetDataSource(targetDataSources.get(dbRouterProperties.getDefaultDb()));</span><br><span class="line">    <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此 <code>determineCurrentLookupKey()</code> 就可以根据 <code>dbKey</code> 来决定具体的数据源</p><h2 id="分表"><a class="markdownIt-Anchor" href="#分表"></a> 分表</h2><p>通过创建 Mybatis 插件以及维护的 <code>tbKey</code>，我们为 SQL 语句所操作的数据表动态的添加后缀，从而起到分表的作用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts(&#123;@Signature(type = StatementHandler.class, method = &quot;prepare&quot;, args = &#123;Connection.class, Integer.class&#125;)&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicMybatisPlugin</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;(from|into|update)[\\s]+(\\w+)&quot;</span>, Pattern.CASE_INSENSITIVE);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 获取StatementHandler</span></span><br><span class="line">        <span class="type">StatementHandler</span> <span class="variable">statementHandler</span> <span class="operator">=</span> (StatementHandler) invocation.getTarget();</span><br><span class="line">        <span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> MetaObject.forObject(statementHandler, SystemMetaObject.DEFAULT_OBJECT_FACTORY, SystemMetaObject.DEFAULT_OBJECT_WRAPPER_FACTORY, <span class="keyword">new</span> <span class="title class_">DefaultReflectorFactory</span>());</span><br><span class="line">        <span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) metaObject.getValue(<span class="string">&quot;delegate.mappedStatement&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取自定义注解判断是否进行分表操作</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> id.substring(<span class="number">0</span>, id.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">     </span><br><span class="line">        <span class="comment">// 获取SQL</span></span><br><span class="line">        <span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> statementHandler.getBoundSql();</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 替换SQL表名 USER 为 USER_03</span></span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(sql);</span><br><span class="line">        <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            tableName = matcher.group().trim();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">assert</span> <span class="literal">null</span> != tableName;</span><br><span class="line">        <span class="type">String</span> <span class="variable">replaceSql</span> <span class="operator">=</span> matcher.replaceAll(tableName + <span class="string">&quot;_&quot;</span> + DBContextHolder.getTbKey());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过反射修改SQL语句</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> boundSql.getClass().getDeclaredField(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(boundSql, replaceSql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://motang.top">贺墨于</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://motang.top/2023/10/24/%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B/">https://motang.top/2023/10/24/%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://motang.top" target="_blank">贺墨于的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">分库分表</a><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E5%90%8E%E5%8F%B0/">后台</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/10/24/SpringSecurity%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/" title="SpringSecurity认证流程"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-24</div><div class="title">SpringSecurity认证流程</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/avatar.webp" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">贺墨于</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">3</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HeMOua" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:fangqichenchao@163.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">1.</span> <span class="toc-text">什么是分库分表？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E5%88%86%E5%BA%93%E4%B8%8D%E5%88%86%E8%A1%A8"><span class="toc-number">1.1.</span> <span class="toc-text">只分库不分表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AA%E5%88%86%E8%A1%A8%E4%B8%8D%E5%88%86%E5%BA%93"><span class="toc-number">1.2.</span> <span class="toc-text">只分表不分库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A2%E5%88%86%E5%BA%93%E5%8F%88%E5%88%86%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">既分库又分表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E9%9C%80%E8%A6%81%E6%95%B0%E6%8D%AE"><span class="toc-number">2.1.</span> <span class="toc-text">确定需要数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-properties"><span class="toc-number">2.2.</span> <span class="toc-text">创建 Properties</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%A6%82%E4%BD%95%E5%86%B3%E5%AE%9A%E5%BA%93%E8%A1%A8"><span class="toc-number">3.</span> <span class="toc-text">运行时如何决定库表？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-dbkey-%E4%BB%A5%E5%8F%8A-tbkey"><span class="toc-number">4.</span> <span class="toc-text">设置 dbKey 以及 tbKey</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E8%A7%A3"><span class="toc-number">4.1.</span> <span class="toc-text">注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%88%87%E9%9D%A2"><span class="toc-number">4.2.</span> <span class="toc-text">创建切面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%BA%93-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8A%A8%E6%80%81%E5%88%87%E6%8D%A2"><span class="toc-number">5.</span> <span class="toc-text">分库 - 数据库动态切换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%A1%A8"><span class="toc-number">6.</span> <span class="toc-text">分表</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/24/SpringSecurity%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/" title="SpringSecurity认证流程">SpringSecurity认证流程</a><time datetime="2023-10-24T14:49:47.982Z" title="发表于 2023-10-24 22:49:47">2023-10-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/10/24/%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B/" title="简单的分库分表实践案例">简单的分库分表实践案例</a><time datetime="2023-10-24T11:48:32.735Z" title="发表于 2023-10-24 19:48:32">2023-10-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/02/07/Zerotier%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Zerotier的使用">Zerotier的使用</a><time datetime="2022-02-07T12:41:28.000Z" title="发表于 2022-02-07 20:41:28">2022-02-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By 贺墨于</div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://hemoua.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.2},options:{renderActions:{findScript:[10,t=>{for(const a of document.querySelectorAll('script[type^="math/tex"]')){var e=!!a.type.match(/; *mode=display/);const n=new t.options.MathItem(a.textContent,t.inputJax[0],e);e=document.createTextNode("");a.parentNode.replaceChild(e,a),n.start={node:e,delim:"",n:0},n.end={node:e,delim:"",n:0},t.math.push(n)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container:not([display])").forEach(t=>{const e=t.parentNode;("li"===e.nodeName.toLowerCase()?e.parentNode:e).classList.add("has-jax")})},"",!1]}}};const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js",a.id="MathJax-script",a.async=!0,document.head.appendChild(a)}</script><script>function loadWaline(){function e(){Waline.init(Object.assign({el:"#waline-wrap",serverURL:"https://my-waline-8q3r2yxkt-hemoua.vercel.app/",pageview:!1,dark:'html[data-theme="dark"]',path:window.location.pathname,comment:!1},null))}if("function"==typeof Waline)e();else{{const n=document.createElement("link");n.rel="stylesheet",n.href="https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.css",document.head.appendChild(n)}getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.js").then(e)}}function loadOtherComment(){loadWaline()}setTimeout(loadWaline,0)</script></div><script defer id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zindex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>